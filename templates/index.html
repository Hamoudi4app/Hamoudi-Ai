<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Hamoudi Ai</title>

  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ (favicon) Ù…Ù† Ù…Ø¬Ù„Ø¯ static -->
  <link rel="icon" type="image/png" href="static/favicon.png" />

  <style>
    :root {
      --primary: #007bff;
      --primary-dark: #0056b3;
      --bg-light: #f9f9f9;
      --bg-card: #ffffff;
      --border: #cccccc;
      --text: #000000;
      --text-invert: #ffffff;

      --bubble-font: 2.2vw;
      --input-font: 2vw;
      --send-size: 8vw;
      --send-font: 3vw;
    }

    @media (max-width: 600px) {
      :root {
        --bubble-font: 18px;
        --input-font: 18px;
        --send-size: 70px;
        --send-font: 28px;
      }
    }

    @media (min-width: 1024px) {
      :root {
        --bubble-font: 20px;
        --input-font: 20px;
        --send-size: 65px;
        --send-font: 26px;
      }
    }

    * { box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-light);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… */
    #theme-toggle-container {
      position: fixed;
      top: env(safe-area-inset-top, 10px);
      right: env(safe-area-inset-right, 10px);
      z-index: 10;
    }
    #toggle-theme {
      width: 45px;
      height: 45px;
      border: none;
      border-radius: 50%;
      background: var(--primary);
      color: var(--text-invert);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.4s ease, background 0.4s ease, color 0.4s ease;
    }
    #toggle-theme:active { transform: scale(0.92) rotate(20deg); }

    /* Ù‡ÙŠØ¯Ø± Ø§Ù„Ø§Ø³Ù… */
    #sidebar-username {
      padding: 15px;
      font-weight: bold;
      background: var(--primary);
      color: var(--text-invert);
      text-align: center;
      font-size: 22px;
    }

    /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
    #chat-box {
      flex: 1;
      overflow-y: auto;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      padding: 16px;
      background: var(--bg-card);
      display: flex;
      flex-direction: column;
      padding-bottom: calc(var(--send-size) + 32px); /* Ù…Ø³Ø§Ø­Ø© Ù„Ø£Ø³ÙÙ„ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØºØ·ÙŠØ© */
      scroll-behavior: smooth;
    }

    /* ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    .message {
      max-width: 80%;
      padding: 16px 20px;
      border-radius: 20px;
      margin: 12px 0;
      font-size: var(--bubble-font);
      line-height: 1.6;
      word-wrap: break-word;
      word-break: break-word;
    }
    .message.ai {
      background: #e5e5ea;
      color: #000;
      align-self: flex-start;
    }
    .message.user {
      background: var(--primary);
      color: var(--text-invert);
      align-self: flex-end;
    }

    /* Ø±ÙˆØ§Ø¨Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    .message a {
      color: #0645ad;
      text-decoration: underline;
      word-break: break-all;
    }
    .dark-mode .message a {
      color: #4da3ff;
    }

    /* Ø®Ø§Ù†Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø«Ø¨ØªØ© Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© */
    #input-area {
      position: fixed;
      bottom: env(safe-area-inset-bottom, 0);
      left: 0;
      right: 0;
      width: 100%;
      display: flex;
      gap: 12px;
      padding: 12px env(safe-area-inset-right, 12px) 12px env(safe-area-inset-left, 12px);
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      z-index: 5;
    }

    #input {
      flex: 1;
      padding: 14px 16px;
      font-size: var(--input-font);
      border: 1px solid var(--border);
      border-radius: 25px;
      outline: none;
      background: #fff;
      color: var(--text);
    }

    #send-btn {
      width: var(--send-size);
      height: var(--send-size);
      font-size: var(--send-font);
      border: none;
      background: var(--primary);
      color: var(--text-invert);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.25s ease, background 0.25s ease;
    }
    #send-btn:active { background: var(--primary-dark); transform: scale(0.94); }

    /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
    .dark-mode {
      background: #222;
      color: #eee;
    }
    .dark-mode #toggle-theme { background: #444; color: #eee; }
    .dark-mode #chat-box {
      background: #333;
      border-color: #444;
    }
    .dark-mode #input {
      background: #444;
      color: #eee;
      border-color: #555;
    }
    .dark-mode #send-btn {
      background: #555;
      color: #eee;
    }
    .dark-mode .message.ai { background: #444; color: #fff; }
    .dark-mode .message.user { background: #0056b3; color: #fff; }
  </style>
</head>
<body>
  <!-- Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… -->
  <div id="theme-toggle-container">
    <button id="toggle-theme" aria-label="Toggle theme">ğŸŒ™</button>
  </div>

  <div id="sidebar-username"></div>

  <div id="chat-box" aria-live="polite" aria-atomic="false"></div>

  <div id="input-area">
    <input id="input" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." autocomplete="off" />
    <button id="send-btn" aria-label="Send">ğŸ¤</button>
  </div>

  <script>
    const chatBox = document.getElementById("chat-box");
    const inputField = document.getElementById("input");
    const actionBtn = document.getElementById("send-btn");
    const toggleBtn = document.getElementById("toggle-theme");
    const usernameEl = document.getElementById("sidebar-username");

    // ØªØ£Ù…ÙŠÙ† HTML Ù„Ù…Ù†Ø¹ XSS
    function escapeHTML(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¥Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¶ØºØ·
    function linkify(text) {
      return text.replace(
        /(https?:\/\/[^\s]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
      );
    }

    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø©
    function addMessage(text, sender = "ai") {
      const div = document.createElement("div");
      div.className = "message " + sender;

      const safe = escapeHTML(text);
      const linked = linkify(safe);

      div.innerHTML = linked;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      saveChat();
    }

    // Ø­ÙØ¸ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    function saveChat() {
      localStorage.setItem("chatHistory", chatBox.innerHTML);
    }
    function loadChat() {
      const history = localStorage.getItem("chatHistory");
      const name = localStorage.getItem("username") || "Ø²Ø§Ø¦Ø±";
      usernameEl.textContent = name;

      if (history) {
        chatBox.innerHTML = history;
      } else {
        addMessage(`Ù…Ø±Ø­Ø¨Ù‹Ø§ ${name}ØŒ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ`, "ai");
      }
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
    async function sendMessage() {
      const text = inputField.value.trim();
      if (!text) return;

      addMessage(text, "user");
      inputField.value = "";
      actionBtn.textContent = "ğŸ¤";

      try {
        const resp = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });
        const data = await resp.json();
        if (data.reply) {
          addMessage(data.reply, "ai");
        } else {
          addMessage(data.error || "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.", "ai");
        }
      } catch (err) {
        addMessage("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….", "ai");
      }
    }

    // Ø¥Ø¯Ø®Ø§Ù„ ØµÙˆØªÙŠ
    function startVoiceRecognition() {
      if ("webkitSpeechRecognition" in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = "ar-SA";
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          inputField.value = transcript;
          sendMessage();
        };

        recognition.onerror = function() {
          addMessage("ØªØ¹Ø°Ø± Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª.", "ai");
        };

        recognition.start();
        addMessage("ğŸ¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...", "ai");
      } else {
        addMessage("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØµÙˆØªÙŠ.", "ai");
      }
    }

    // ØªØ¨Ø¯ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠÙ† Ù…Ø§ÙŠÙƒ ÙˆØ³Ù‡Ù…
    inputField.addEventListener("input", () => {
      actionBtn.textContent = inputField.value.trim().length > 0 ? "â¤" : "ğŸ¤";
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø£Ùˆ Ø¨Ø¯Ø¡ Ø§Ù„ØµÙˆØª
    actionBtn.addEventListener("click", () => {
      if (inputField.value.trim().length > 0) {
        sendMessage();
      } else {
        startVoiceRecognition();
      }
    });

    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… Ù…Ø¹ Ø£Ù†ÙŠÙ…ÙŠØ´Ù† ÙˆØ­ÙØ¸ Ø§Ù„ØªÙØ¶ÙŠÙ„
    toggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      toggleBtn.textContent = isDark ? "â˜€ï¸" : "ğŸŒ™";

      toggleBtn.style.transform = "rotate(360deg)";
      setTimeout(() => { toggleBtn.style.transform = "rotate(0deg)"; }, 400);

      localStorage.setItem("prefersDark", isDark ? "1" : "0");
    });

    // ØªØ·Ø¨ÙŠÙ‚ ØªÙØ¶ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ù…Ø®Ø²Ù†
    (function applySavedTheme() {
      const prefersDark = localStorage.getItem("prefersDark") === "1";
      if (prefersDark) {
        document.body.classList.add("dark-mode");
        toggleBtn.textContent = "â˜€ï¸";
      } else {
        toggleBtn.textContent = "ğŸŒ™";
      }
    })();

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    window.addEventListener("load", loadChat);

    // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø£Ø³ÙÙ„ Ø¹Ù†Ø¯ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø­Ø¬Ù… (Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù‡Ø§ØªÙ)
    window.addEventListener("resize", () => {
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±
    inputField.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
