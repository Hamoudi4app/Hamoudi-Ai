<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Chat App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #theme-toggle-container {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 10;
    }
    #toggle-theme {
      width: 70px;
      height: 70px;
      border: none;
      border-radius: 50%;
      background: #007bff;
      color: #fff;
      font-size: 28px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.4s ease;
    }

    #sidebar-username {
      padding: 15px;
      font-weight: bold;
      background: #007bff;
      color: #fff;
      text-align: center;
      font-size: 20px;
    }

    #chat-box {
      flex: 1;
      overflow-y: auto;
      border-top: 1px solid #ccc;
      border-bottom: 1px solid #ccc;
      padding: 16px;
      background: #fff;
      display: flex;
      flex-direction: column;
      padding-bottom: 90px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù…Ø¯Ø®Ù„ */
    }

    .message {
      max-width: 80%;
      padding: 14px 18px;
      border-radius: 20px;
      margin: 10px 0;
      font-size: 18px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    .message.ai {
      background: #e5e5ea;
      color: #000;
      align-self: flex-start;
    }
    .message.user {
      background: #007bff;
      color: #fff;
      align-self: flex-end;
    }

    #input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      display: flex;
      gap: 12px;
      padding: 12px;
      background: #fff;
      border-top: 1px solid #ccc;
      z-index: 5;
    }

    #input {
      flex: 1;
      padding: 14px;
      font-size: 18px;
      border: 1px solid #ccc;
      border-radius: 25px;
      outline: none;
    }

    #send-btn {
      width: 65px;
      height: 65px;
      font-size: 26px;
      border: none;
      background: #007bff;
      color: #fff;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.25s ease;
    }
    #send-btn:active { background: #0056b3; transform: scale(0.94); }

    /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
    .dark-mode { background: #222; color: #eee; }
    .dark-mode #chat-box { background: #333; border-color: #444; }
    .dark-mode #input { background: #444; color: #eee; border-color: #555; }
    .dark-mode #send-btn { background: #555; color: #eee; }
    .dark-mode .message.ai { background: #444; color: #fff; }
    .dark-mode .message.user { background: #0056b3; color: #fff; }

    /* Ø±ÙˆØ§Ø¨Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    .message a {
      color: #0645ad;
      text-decoration: underline;
    }
    .dark-mode .message a {
      color: #4da3ff;
    }
  </style>
</head>
<body>
  <div id="theme-toggle-container">
    <button id="toggle-theme">ğŸŒ™</button>
  </div>

  <div id="sidebar-username"></div>
  <div id="chat-box"></div>
  <div id="input-area">
    <input id="input" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." autocomplete="off" />
    <button id="send-btn">ğŸ¤</button>
  </div>

  <script>
    const chatBox = document.getElementById("chat-box");
    const inputField = document.getElementById("input");
    const actionBtn = document.getElementById("send-btn");
    const toggleBtn = document.getElementById("toggle-theme");
    const usernameEl = document.getElementById("sidebar-username");

    function addMessage(text, sender = "ai") {
      const div = document.createElement("div");
      div.className = "message " + sender;

      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¥Ù„Ù‰ Ø¹Ù†Ø§ØµØ± <a>
      const linkedText = text.replace(
        /(https?:\/\/[^\s]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
      );

      div.innerHTML = linkedText;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      saveChat();
    }

    function saveChat() {
      localStorage.setItem("chatHistory", chatBox.innerHTML);
    }

    function loadChat() {
      const history = localStorage.getItem("chatHistory");
      const name = localStorage.getItem("username") || "Ø²Ø§Ø¦Ø±";
      usernameEl.textContent = name;

      if (history) {
        chatBox.innerHTML = history;
      } else {
        addMessage(`Ù…Ø±Ø­Ø¨Ù‹Ø§ ${name}ØŒ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ`, "ai");
      }
    }

    async function sendMessage() {
      const text = inputField.value.trim();
      if (!text) return;

      addMessage(text, "user");
      inputField.value = "";
      actionBtn.textContent = "ğŸ¤";

      try {
        const resp = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });
        const data = await resp.json();
        if (data.reply) {
          addMessage(data.reply, "ai");
        } else {
          addMessage(data.error || "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.", "ai");
        }
      } catch (err) {
        addMessage("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….", "ai");
      }
    }

    inputField.addEventListener("input", () => {
      actionBtn.textContent = inputField.value.trim().length > 0 ? "â¤" : "ğŸ¤";
    });

    actionBtn.addEventListener("click", () => {
      if (inputField.value.trim().length > 0) {
        sendMessage();
      } else {
        startVoiceRecognition();
      }
    });

    function startVoiceRecognition() {
      if ("webkitSpeechRecognition" in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = "ar-SA";
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          inputField.value = transcript;
          sendMessage();
        };

        recognition.onerror = function() {
          addMessage("ØªØ¹Ø°Ø± Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª.", "ai");
        };

        recognition.start();
        addMessage("ğŸ¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...", "ai");
      } else {
        addMessage("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØµÙˆØªÙŠ.", "ai");
      }
    }

    toggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      toggleBtn.textContent = isDark ? "â˜€ï¸" : "ğŸŒ™";
    });

    window.addEventListener("load", loadChat);
  </script>
</body>
</html>
