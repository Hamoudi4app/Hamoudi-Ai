<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
  <style>
    body { font-family: Arial, sans-serif; }
    #chat-box { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    .message { margin: 5px 0; display: flex; align-items: center; }
    .message.ai { color: #333; }
    .message.user { color: #007bff; }
    .avatar { margin-right: 8px; }
    #input-area { display: flex; margin-top: 10px; }
    #input { flex: 1; padding: 5px; }
    #send-btn { padding: 5px 10px; font-size: 18px; }
    .dark-mode { background: #222; color: #eee; }
  </style>
</head>
<body>
  <div id="sidebar-username"></div>
  <div id="chat-box"></div>
  <div id="input-area">
    <input id="input" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">
    <button id="send-btn">ğŸ¤</button>
  </div>
  <button id="toggle-theme">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…</button>

  <script>
    const chatBox = document.getElementById("chat-box");

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function loadChat() {
      const history = localStorage.getItem("chatHistory");
      if (history) {
        chatBox.innerHTML = history;
      } else {
        // Ø£ÙˆÙ„ Ù…Ø±Ø© ÙŠØ¯Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… â†’ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
        const name = localStorage.getItem("username") || "Ø²Ø§Ø¦Ø±";
        addMessage(`Ù…Ø±Ø­Ø¨Ø§ ${name}ØŒ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ`, "ai");
      }

      const name = localStorage.getItem("username") || "Ø²Ø§Ø¦Ø±";
      document.getElementById("sidebar-username").textContent = name;
    }

    // Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    function saveChat() {
      localStorage.setItem("chatHistory", chatBox.innerHTML);
    }

    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø©
    function addMessage(text, sender = "ai") {
      const div = document.createElement("div");
      div.className = "message " + sender;

      const avatar = document.createElement("span");
      avatar.className = "avatar";
      avatar.textContent = sender === "user" ? "ğŸ‘¤" : "ğŸ¤–";

      const content = document.createElement("span");
      content.innerHTML = text;

      div.appendChild(avatar);
      div.appendChild(content);
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      saveChat();
    }

    // Ø¥Ø¶Ø§ÙØ© ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    function addImages(images, titleText = "ØµÙˆØ±") {
      const div = document.createElement("div");
      div.className = "message ai";

      const avatar = document.createElement("span");
      avatar.className = "avatar";
      avatar.textContent = "ğŸ¤–";
      div.appendChild(avatar);

      const title = document.createElement("div");
      title.textContent = titleText;
      div.appendChild(title);

      const imgContainer = document.createElement("div");
      imgContainer.className = "images";

      images.forEach(img => {
        const link = document.createElement("a");
        link.href = img.image;
        link.target = "_blank";
        link.rel = "noopener noreferrer";

        const image = document.createElement("img");
        image.src = img.image;
        image.alt = img.title || "ØµÙˆØ±Ø©";

        link.appendChild(image);
        imgContainer.appendChild(link);
      });

      div.appendChild(imgContainer);
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      saveChat();
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
    async function sendMessage() {
      const input = document.getElementById("input");
      const text = input.value.trim();
      if (!text) return;

      addMessage(text, "user");
      input.value = "";
      actionBtn.textContent = "ğŸ¤"; // ÙŠØ±Ø¬Ø¹ Ø§Ù„Ø²Ø± Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„

      // Ø§Ù„Ø±Ø¯ Ø§Ù„Ù†ØµÙŠ Ù…Ù† /api/chat
      try {
        const resp = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });
        const data = await resp.json();
        if (data.reply) {
          addMessage(data.reply, "ai");
        } else {
          addMessage(data.error || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ", "ai");
        }
      } catch (err) {
        addMessage("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….", "ai");
      }
    }

    // Ø²Ø± ÙˆØ§Ø­Ø¯ ÙŠØªØºÙŠØ± Ø¨ÙŠÙ† ğŸ¤ Ùˆ â¤
    const inputField = document.getElementById("input");
    const actionBtn = document.getElementById("send-btn");

    inputField.addEventListener("input", () => {
      if (inputField.value.trim().length > 0) {
        actionBtn.textContent = "â¤"; // Ø²Ø± Ø¥Ø±Ø³Ø§Ù„
      } else {
        actionBtn.textContent = "ğŸ¤"; // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ
      }
    });

    actionBtn.addEventListener("click", () => {
      if (inputField.value.trim().length > 0) {
        sendMessage(); // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Øµ
      } else {
        startVoiceRecognition(); // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
      }
    });

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
    function startVoiceRecognition() {
      if ("webkitSpeechRecognition" in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = "ar-SA";
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          inputField.value = transcript;
          sendMessage(); // ÙŠØ±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø±Ù
        };

        recognition.onerror = function() {
          addMessage("ØªØ¹Ø°Ø± Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª.", "ai");
        };

        recognition.start();
        addMessage("ğŸ¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...", "ai");
      } else {
        addMessage("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØµÙˆØªÙŠ.", "ai");
      }
    }

    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…
    document.getElementById("toggle-theme").addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
    });

    // ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    window.onload = loadChat;
  </script>
</body>
</html>
