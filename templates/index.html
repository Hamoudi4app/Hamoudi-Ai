<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      position: relative;
    }

    /* Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… */
    #theme-toggle-container {
      position: absolute;
      top: 10px;
      right: 10px;
    }

    #toggle-theme {
      width: 70px;   /* Ø£ÙƒØ¨Ø± */
      height: 70px;
      border: none;
      border-radius: 50%;
      background: #007bff;
      color: #fff;
      font-size: 28px; /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø£ÙƒØ¨Ø± */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: transform 0.4s ease, background 0.4s ease, color 0.4s ease;
    }

    #toggle-theme:active {
      transform: scale(0.9) rotate(20deg); /* Ù…Ø¤Ø«Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
    }

    .dark-mode #toggle-theme {
      background: #444;
      color: #eee;
    }

    #sidebar-username {
      padding: 4vh;
      font-weight: bold;
      background: #007bff;
      color: #fff;
      text-align: center;
      font-size: 5vw;
    }

    #chat-box {
      height: 65vh;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 3vw;
      background: #fff;
      font-size: 4vw;
    }

    .message {
      margin: 2vh 0;
      display: flex;
      align-items: flex-start;
    }

    .message.ai {
      color: #333;
    }

    .message.user {
      color: #007bff;
      justify-content: flex-end;
    }

    .avatar {
      margin-right: 2vw;
      font-size: 5vw;
    }

    #input-area {
      display: flex;
      padding: 2vh;
      background: #fff;
      border-top: 1px solid #ccc;
    }

    #input {
      flex: 1;
      padding: 2vh;
      font-size: 4vw;
      border: 1px solid #ccc;
      border-radius: 25px;
      outline: none;
    }

    #send-btn {
      margin-left: 2vw;
      width: 12vw;
      height: 12vw;
      font-size: 6vw;
      border: none;
      background: #007bff;
      color: #fff;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease;
    }

    #send-btn:active {
      background: #0056b3;
      transform: scale(0.9);
    }

    /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
    .dark-mode {
      background: #222;
      color: #eee;
    }

    .dark-mode #chat-box {
      background: #333;
      border-color: #444;
    }

    .dark-mode #input {
      background: #444;
      color: #eee;
      border-color: #555;
    }

    .dark-mode #send-btn {
      background: #555;
      color: #eee;
    }
  </style>
</head>
<body>
  <!-- Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… -->
  <div id="theme-toggle-container">
    <button id="toggle-theme">ğŸŒ™</button>
  </div>

  <div id="sidebar-username"></div>
  <div id="chat-box"></div>
  <div id="input-area">
    <input id="input" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">
    <button id="send-btn">ğŸ¤</button>
  </div>

  <script>
    const chatBox = document.getElementById("chat-box");

    function loadChat() {
      const history = localStorage.getItem("chatHistory");
      if (history) {
        chatBox.innerHTML = history;
      } else {
        const name = localStorage.getItem("username") || "Ø²Ø§Ø¦Ø±";
        addMessage(`Ù…Ø±Ø­Ø¨Ø§ ${name}ØŒ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ`, "ai");
      }
      const name = localStorage.getItem("username") || "Ø²Ø§Ø¦Ø±";
      document.getElementById("sidebar-username").textContent = name;
    }

    function saveChat() {
      localStorage.setItem("chatHistory", chatBox.innerHTML);
    }

    function addMessage(text, sender = "ai") {
      const div = document.createElement("div");
      div.className = "message " + sender;

      const avatar = document.createElement("span");
      avatar.className = "avatar";
      avatar.textContent = sender === "user" ? "ğŸ‘¤" : "ğŸ¤–";

      const content = document.createElement("span");
      content.innerHTML = text;

      div.appendChild(avatar);
      div.appendChild(content);
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      saveChat();
    }

    async function sendMessage() {
      const text = inputField.value.trim();
      if (!text) return;

      addMessage(text, "user");
      inputField.value = "";
      actionBtn.textContent = "ğŸ¤";

      try {
        const resp = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });
        const data = await resp.json();
        if (data.reply) {
          addMessage(data.reply, "ai");
        } else {
          addMessage(data.error || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ", "ai");
        }
      } catch (err) {
        addMessage("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….", "ai");
      }
    }

    const inputField = document.getElementById("input");
    const actionBtn = document.getElementById("send-btn");

    inputField.addEventListener("input", () => {
      if (inputField.value.trim().length > 0) {
        actionBtn.textContent = "â¤";
      } else {
        actionBtn.textContent = "ğŸ¤";
      }
    });

    actionBtn.addEventListener("click", () => {
      if (inputField.value.trim().length > 0) {
        sendMessage();
      } else {
        startVoiceRecognition();
      }
    });

    function startVoiceRecognition() {
      if ("webkitSpeechRecognition" in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = "ar-SA";
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          inputField.value = transcript;
          sendMessage();
        };

        recognition.onerror = function() {
          addMessage("ØªØ¹Ø°Ø± Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª.", "ai");
        };

        recognition.start();
        addMessage("ğŸ¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...", "ai");
      } else {
        addMessage("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØµÙˆØªÙŠ.", "ai");
      }
    }

    const toggleBtn = document.getElementById("toggle-theme");
    toggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");

      // Ù…Ø¤Ø«Ø± Ø¯ÙˆØ±Ø§Ù† Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
      toggleBtn.style.transform = "rotate(360deg)";
      setTimeout(() => {
        toggleBtn.style.transform = "rotate(0deg)";
      }, 400);

      if (document.body.classList.contains("dark-mode")) {
        toggleBtn.textContent = "â˜€ï¸"; // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø´Ù…Ø³ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†
      } else {
        toggleBtn.textContent = "ğŸŒ™"; // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‚Ù…Ø± Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­
      }
    });

    window.onload = loadChat;
  </script>
</body>
</html>
