<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Hamoudi Ai</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: "Cairo", sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #f5f5f5;
    }

    /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ ÙƒÙ€ Drawer */
    #sidebar {
      position: fixed;
      top: 0;
      left: -100%; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
      width: 280px;
      max-width: 85vw;
      height: 100%;
      background: #2c2c54;
      color: #fff;
      padding: 20px;
      box-sizing: border-box;
      transition: left 0.3s ease;
      display: flex;
      flex-direction: column;
      z-index: 1001;
    }
    #sidebar.active { left: 0; }

    #close-sidebar {
      align-self: flex-end;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    #sidebar h3 {
      margin: 0 0 8px;
      font-size: 18px;
      text-align: center;
    }
    #sidebar p {
      font-size: 14px;
      text-align: center;
      margin: 0 0 12px;
      opacity: 0.9;
    }
    #logout-btn {
      margin-top: auto;
      width: 100%;
      padding: 10px 16px;
      background: red;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    #logout-btn:hover { background: darkred; }

    /* Overlay Ù„Ù„Ø®Ù„ÙÙŠØ© */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      z-index: 1000;
    }
    #overlay.active { display: block; }

    /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
    header {
      background: #4facfe;
      color: #fff;
      padding: 15px;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      justify-content: center; /* Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ */
      align-items: center;
      position: relative;
    }
    #toggle-sidebar {
      position: absolute;
      left: 15px;
      background: transparent;
      border: none;
      font-size: 22px;
      color: #fff;
      cursor: pointer;
    }
    #toggle-theme {
      position: absolute;
      right: 15px;
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #fff;
    }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
    #chat {
      flex: 1;
      background: #fff;
      padding: 15px;
      overflow-y: auto;
      transition: background 0.3s, color 0.3s;
    }

    .message {
      margin: 8px 0;
      padding: 10px 14px;
      border-radius: 20px;
      max-width: 80%;
      word-wrap: break-word;
      font-size: 15px;
      display: flex;
      align-items: center;
    }

    .user {
      background: #4facfe;
      color: #fff;
      margin-left: auto;
      text-align: right;
    }

    .ai {
      background: #f5f5f5;
      color: #333;
      margin-right: auto;
      text-align: left;
    }

    .avatar {
      margin-right: 8px;
      font-size: 18px;
      flex: 0 0 auto;
    }

    .images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 10px;
      margin-top: 8px;
      width: 100%;
    }
    .images a {
      display: block;
      border-radius: 10px;
      overflow: hidden;
    }
    .images img {
      width: 100%;
      display: block;
      border-radius: 10px;
      transition: transform 0.2s;
    }
    .images img:hover { transform: scale(1.05); }

    /* Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    #input-area {
      display: flex;
      padding: 10px;
      background: #fff;
      border-top: 1px solid #ddd;
      gap: 10px;
    }
    #input {
      flex: 1;
      padding: 12px;
      border-radius: 25px;
      border: 1px solid #ccc;
      outline: none;
      font-size: 15px;
    }
    #send-btn {
      padding: 0 18px;
      border: none;
      border-radius: 25px;
      background: #4facfe;
      color: #fff;
      cursor: pointer;
      font-size: 18px;
    }
    #send-btn:hover { background: #00c6ff; }

    /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
    body.dark-mode { background: #121212; color: #eee; }
    body.dark-mode #chat { background: #1e1e1e; color: #eee; }
    body.dark-mode .user { background: #333; color: #fff; }
    body.dark-mode .ai { background: #444; color: #eee; }

    /* ØªØ¬Ø§ÙˆØ¨ Ø§Ù„Ù‡Ø§ØªÙ */
    @media (max-width: 768px) {
      #sidebar { width: 100%; max-width: 100%; }
    }
  </style>
</head>
<body>
  <!-- Overlay -->
  <div id="overlay"></div>

  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
  <aside id="sidebar">
    <button id="close-sidebar">âœ–</button>
    <h3 id="sidebar-username">Ø²Ø§Ø¦Ø±</h3>
    <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Hamoudi Ai</p>
    <button id="logout-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </aside>

  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <header>
    <button id="toggle-sidebar">â˜°</button>
    Hamoudi Ai
    <button id="toggle-theme">ğŸŒ“</button>
  </header>

  <div id="chat"></div>

  <div id="input-area">
    <input id="input" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">
    <button id="send-btn" onclick="sendMessage()">â¤</button>
  </div>

  <script>
    const chatBox = document.getElementById("chat");
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    const toggleSidebarBtn = document.getElementById("toggle-sidebar");
    const closeSidebarBtn = document.getElementById("close-sidebar");
    const logoutBtn = document.getElementById("logout-btn");

    // ÙØªØ­ Ø§Ù„Ø´Ø±ÙŠØ·
    toggleSidebarBtn.addEventListener("click", () => {
      sidebar.classList.add("active");
      overlay.classList.add("active");
    });

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø±ÙŠØ·
    function closeDrawer() {
      sidebar.classList.remove("active");
      overlay.classList.remove("active");
    }
    closeSidebarBtn.addEventListener("click", closeDrawer);
    overlay.addEventListener("click", closeDrawer);

    // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ â†’ static/login.html
logoutBtn.addEventListener("click", () => {
  localStorage.clear();
  window.location.href = "/logout"; // ÙŠØ®Ù„ÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØªÙˆÙ„Ù‰ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØµÙØ­Ø© login.html
});

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¥Ù„Ù‰ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ù‚Ø±
    function linkify(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, url => '<a href="' + url + '" target="_blank" rel="noopener noreferrer">' + url + '</a>');
    }

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function loadChat() {
  const history = localStorage.getItem("chatHistory");
  if (history) {
    chatBox.innerHTML = history;
  } else {
    // Ø£ÙˆÙ„ Ù…Ø±Ø© ÙŠØ¯Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… â†’ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
    const name = localStorage.getItem("username") || "Ø²Ø§Ø¦Ø±";
    addMessage(`Ù…Ø±Ø­Ø¨Ø§ ${name}ØŒ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ`, "ai");
  }

  const name = localStorage.getItem("username") || "Ø²Ø§Ø¦Ø±";
  document.getElementById("sidebar-username").textContent = name;
}

// Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
function saveChat() {
  localStorage.setItem("chatHistory", chatBox.innerHTML);
}

// Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø©
function addMessage(text, sender = "ai") {
  const div = document.createElement("div");
  div.className = "message " + sender;

  const avatar = document.createElement("span");
  avatar.className = "avatar";
  avatar.textContent = sender === "user" ? "ğŸ‘¤" : "ğŸ¤–";

  const content = document.createElement("span");
  content.innerHTML = linkify(text);

  div.appendChild(avatar);
  div.appendChild(content);
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
  saveChat();
}

// Ø¥Ø¶Ø§ÙØ© ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
function addImages(images, titleText = "ØµÙˆØ±") {
  const div = document.createElement("div");
  div.className = "message ai";

  const avatar = document.createElement("span");
  avatar.className = "avatar";
  avatar.textContent = "ğŸ¤–";
  div.appendChild(avatar);

  const title = document.createElement("div");
  title.textContent = titleText;
  div.appendChild(title);

  const imgContainer = document.createElement("div");
  imgContainer.className = "images";

  images.forEach(img => {
    const link = document.createElement("a");
    link.href = img.image;
    link.target = "_blank";
    link.rel = "noopener noreferrer";

    const image = document.createElement("img");
    image.src = img.image;
    image.alt = img.title || "ØµÙˆØ±Ø©";

    link.appendChild(image);
    imgContainer.appendChild(link);
  });

  div.appendChild(imgContainer);
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
  saveChat();
}

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
async function sendMessage() {
  const input = document.getElementById("input");
  const text = input.value.trim();
  if (!text) return;

  addMessage(text, "user");
  input.value = "";

  // ØªØ­Ø¯ÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„ØµÙˆØ±
  const isImageQuery =
    text.startsWith("Ù‡Ø§Øª ØµÙˆØ±") ||
    text.startsWith("ØµÙˆØ±Ø©") ||
    text.includes("ØµÙˆØ± Ø¹Ù†") ||
    text.includes("Ø§Ø¹Ø±Ø¶ ØµÙˆØ±") ||
    text.includes("ØµÙˆØ± Ù„Ù€") ||
    text.includes("ØµÙˆØ± Ù„ ") ||
    text.includes("Ø§Ù„Ù…Ø·ÙˆØ± Ù…Ø­Ù…Ø¯ ÙÙŠØµÙ„");

  if (isImageQuery) {
    const q = text
      .replace(/^Ù‡Ø§Øª ØµÙˆØ±\s*/, "")
      .replace(/^ØµÙˆØ±Ø©\s*/, "")
      .replace(/(Ø§Ø¹Ø±Ø¶ ØµÙˆØ±|ØµÙˆØ± Ø¹Ù†|ØµÙˆØ± Ù„Ù€|ØµÙˆØ± Ù„ )/, "")
      .trim() || text;

    try {
      const resp = await fetch(`/api/images?q=${encodeURIComponent(q)}`);
      const data = await resp.json();
      if (data.images && data.images.length > 0) {
        addImages(data.images, `ØµÙˆØ± Ø¹Ù† ${q}`);
      } else {
        addMessage("Ù„Ù… Ø£Ø¬Ø¯ ØµÙˆØ± Ù…Ù†Ø§Ø³Ø¨Ø©.", "ai");
      }
    } catch (err) {
      addMessage("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±.", "ai");
    }
    return;
  }

  // Ø§Ù„Ø±Ø¯ Ø§Ù„Ù†ØµÙŠ Ù…Ù† /api/chat
  try {
    const resp = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text })
    });
    const data = await resp.json();
    if (data.reply) {
      addMessage(data.reply, "ai");
    } else {
      addMessage(data.error || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ", "ai");
    }
  } catch (err) {
    addMessage("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….", "ai");
  }
}

// ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…
document.getElementById("toggle-theme").addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
});

// Ø²Ø± ÙˆØ§Ø­Ø¯ ÙŠØªØºÙŠØ± Ø¨ÙŠÙ† ğŸ¤ Ùˆ â¤
const inputField = document.getElementById("input");
const actionBtn = document.getElementById("send-btn"); // ØªØ£ÙƒØ¯ Ø£Ù† Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯Ùƒ id="send-btn"

// Ø±Ø§Ù‚Ø¨ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¯Ø§Ø®Ù„ Ø®Ø§Ù†Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
inputField.addEventListener("input", () => {
  if (inputField.value.trim().length > 0) {
    actionBtn.textContent = "â¤"; // Ø²Ø± Ø¥Ø±Ø³Ø§Ù„
  } else {
    actionBtn.textContent = "ğŸ¤"; // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ
  }
});

// ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
window.onload = loadChat;
